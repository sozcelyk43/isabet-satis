<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İsabet Satış Programı</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2, h3 { color: #2c3e50; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], textarea, select {
            width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; font-size: 16px;
        }
        button:hover { background-color: #2980b9; }
        button.delete { background-color: #e74c3c; }
        button.delete:hover { background-color: #c0392b; }
        button.edit { background-color: #f39c12; }
        button.edit:hover { background-color: #e67e22; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #ecf0f1; }
        pre { background-color: #eee; padding: 10px; border: 1px solid #ccc; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;}
        .section { margin-bottom: 30px; }
        .hidden { display: none; }
        #programAdi { text-align: center; margin-bottom: 30px; font-size: 2em; }
        #cartItems li { margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        #cartItems li button { margin-left: 10px; padding: 2px 5px; font-size: 12px; margin-top: 0;}
    </style>
</head>
<body>

    <h1 id="programAdi">Yükleniyor...</h1>

    <div class="container section">
        <h2>Program Bilgileri</h2>
        <p><strong>Masa Sayısı:</strong> <span id="masaSayisi">Yükleniyor...</span></p>
    </div>

    <div class="container section">
        <h2>Ürün Yönetimi</h2>
        <h3>Yeni Ürün Ekle / Düzenle</h3>
        <form id="productForm">
            <input type="hidden" id="productId">
            <div>
                <label for="productName">Ürün Adı:</label>
                <input type="text" id="productName" required>
            </div>
            <div>
                <label for="productPrice">Fiyat:</label>
                <input type="number" id="productPrice" step="0.01" required>
            </div>
            <div>
                <label for="productDescription">Açıklama:</label>
                <textarea id="productDescription"></textarea>
            </div>
            <div>
                <label for="productStock">Stok:</label>
                <input type="number" id="productStock" value="0" min="0">
            </div>
            <button type="submit" id="saveProductButton">Ürün Ekle</button>
            <button type="button" id="cancelEditButton" class="hidden" style="background-color: #7f8c8d;">İptal</button>
        </form>

        <h3>Mevcut Ürünler</h3>
        <table id="productsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ad</th>
                    <th>Fiyat (TL)</th>
                    <th>Açıklama</th>
                    <th>Stok</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div class="container section">
        <h2>Satış İşlemi (POS)</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 300px;">
                <h3>Sepete Ürün Ekle</h3>
                <div>
                    <label for="posProductSelect">Ürün Seç:</label>
                    <select id="posProductSelect"></select>
                </div>
                <div>
                    <label for="posQuantity">Miktar:</label>
                    <input type="number" id="posQuantity" value="1" min="1">
                </div>
                <button type="button" id="addToCartButton">Sepete Ekle</button>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h3>Sepet</h3>
                <ul id="cartItems"></ul>
                <p><strong>Toplam Tutar:</strong> <span id="cartTotal">0.00</span> TL</p>
                <div>
                    <label for="tableNumber">Masa Numarası:</label>
                    <select id="tableNumber"></select>
                </div>
                <div>
                    <label for="paymentType">Ödeme Yöntemi:</label>
                    <select id="paymentType">
                        <option value="Nakit">Nakit</option>
                        <option value="Kredi Kartı">Kredi Kartı</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>
                <button type="button" id="completeSaleButton">Satışı Tamamla</button>
            </div>
        </div>
    </div>


    <div class="container section">
        <h2>Loglar</h2>
        <button type="button" id="fetchSalesLogButton">Satış Loglarını Göster</button>
        <button type="button" id="fetchActivityLogButton">Aktivite Loglarını Göster</button>
        <h3 id="logTitle" class="hidden">Log Kayıtları</h3>
        <pre id="logData" class="hidden">Log verisi burada gösterilecek.</pre>
    </div>

<script>
    const API_BASE_URL = '';

    let masaSayisiGlobal = 0;
    let currentCart = [];
    let allProducts = [];

    async function fetchData(endpoint, options = {}) {
        try {
            const response = await fetch(`${API_BASE_URL}/api${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Bilinmeyen sunucu hatası'}`);
            }
            if (response.status === 204 || response.headers.get("content-length") === "0") return null;
            return await response.json();
        } catch (error) {
            console.error(`Error fetching ${endpoint}:`, error);
            alert(`İstek sırasında hata: ${error.message}`);
            throw error;
        }
    }

    async function loadProgramInfo() {
        try {
            const info = await fetchData('/info');
            document.getElementById('programAdi').textContent = info.programAdi;
            document.getElementById('masaSayisi').textContent = info.masaSayisi;
            masaSayisiGlobal = info.masaSayisi;
            populateTableSelect(info.masaSayisi);
        } catch (error) {
            document.getElementById('programAdi').textContent = "Program Bilgileri Yüklenemedi";
        }
    }

    function populateTableSelect(count) {
        const tableSelect = document.getElementById('tableNumber');
        tableSelect.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Masa ${i}`;
            tableSelect.appendChild(option);
        }
    }

    const productForm = document.getElementById('productForm');
    const productsTableBody = document.getElementById('productsTable').getElementsByTagName('tbody')[0];
    const productIdInput = document.getElementById('productId');
    const productNameInput = document.getElementById('productName');
    const productPriceInput = document.getElementById('productPrice');
    const productDescriptionInput = document.getElementById('productDescription');
    const productStockInput = document.getElementById('productStock');
    const saveProductButton = document.getElementById('saveProductButton');
    const cancelEditButton = document.getElementById('cancelEditButton');

    async function loadProducts() {
        try {
            allProducts = await fetchData('/products');
            productsTableBody.innerHTML = '';
            const posProductSelect = document.getElementById('posProductSelect');
            posProductSelect.innerHTML = '<option value="">Ürün Seçin...</option>';

            allProducts.forEach(product => {
                const row = productsTableBody.insertRow();
                row.insertCell().textContent = product.id;
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = parseFloat(product.price).toFixed(2);
                row.insertCell().textContent = product.description || '';
                row.insertCell().textContent = product.stock;

                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'Düzenle';
                editButton.classList.add('edit');
                editButton.onclick = () => populateProductFormForEdit(product);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Sil';
                deleteButton.classList.add('delete');
                deleteButton.style.marginLeft = '5px';
                deleteButton.onclick = () => deleteProduct(product.id, product.name);
                actionsCell.appendChild(deleteButton);

                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${parseFloat(product.price).toFixed(2)} TL)`;
                posProductSelect.appendChild(option);
            });
        } catch (error) {
            productsTableBody.innerHTML = '<tr><td colspan="6">Ürünler yüklenemedi.</td></tr>';
        }
    }

    function populateProductFormForEdit(product) {
        productIdInput.value = product.id;
        productNameInput.value = product.name;
        productPriceInput.value = parseFloat(product.price).toFixed(2);
        productDescriptionInput.value = product.description || '';
        productStockInput.value = product.stock;
        saveProductButton.textContent = 'Ürünü Güncelle';
        cancelEditButton.classList.remove('hidden');
        productNameInput.focus();
        window.scrollTo({ top: productForm.offsetTop - 20 , behavior: 'smooth' });
    }

    function resetProductForm() {
        productForm.reset();
        productIdInput.value = '';
        saveProductButton.textContent = 'Ürün Ekle';
        cancelEditButton.classList.add('hidden');
    }

    cancelEditButton.addEventListener('click', resetProductForm);

    productForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const productData = {
            name: productNameInput.value,
            price: parseFloat(productPriceInput.value),
            description: productDescriptionInput.value,
            stock: parseInt(productStockInput.value)
        };

        const id = productIdInput.value;
        try {
            if (id) {
                await fetchData(`/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                alert('Ürün başarıyla güncellendi!');
            } else {
                await fetchData('/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                alert('Ürün başarıyla eklendi!');
            }
            resetProductForm();
            loadProducts();
        } catch (error) {
            // Handled by fetchData
        }
    });

    async function deleteProduct(id, name) {
        if (confirm(`"${name}" adlı ürünü silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
            try {
                await fetchData(`/products/${id}`, { method: 'DELETE' });
                alert('Ürün başarıyla silindi!');
                loadProducts();
                resetProductForm(); // Eğer silinen ürün formda ise formu temizle
            } catch (error) {
                 // Handled by fetchData
            }
        }
    }

    const addToCartButton = document.getElementById('addToCartButton');
    const posProductSelect = document.getElementById('posProductSelect');
    const posQuantityInput = document.getElementById('posQuantity');
    const cartItemsUl = document.getElementById('cartItems');
    const cartTotalSpan = document.getElementById('cartTotal');
    const completeSaleButton = document.getElementById('completeSaleButton');

    addToCartButton.addEventListener('click', () => {
        const selectedOption = posProductSelect.options[posProductSelect.selectedIndex];
        if (!selectedOption.value) {
            alert('Lütfen bir ürün seçin.');
            return;
        }
        const productId = parseInt(selectedOption.value);
        const quantity = parseInt(posQuantityInput.value);

        if (quantity <= 0) {
            alert('Miktar 0 dan büyük olmalıdır.');
            return;
        }
        
        const productDetails = allProducts.find(p => p.id === productId);
        if (!productDetails) {
            alert('Seçilen ürün bulunamadı.');
            return;
        }

        const existingItemIndex = currentCart.findIndex(item => item.productId === productId);
        if (existingItemIndex > -1) {
            currentCart[existingItemIndex].quantity += quantity;
        } else {
            currentCart.push({
                productId: productId,
                name: productDetails.name,
                priceAtSale: parseFloat(productDetails.price),
                quantity: quantity
            });
        }
        renderCart();
    });

    function renderCart() {
        cartItemsUl.innerHTML = '';
        let total = 0;
        currentCart.forEach((item, index) => {
            const li = document.createElement('li');
            const itemText = document.createElement('span');
            itemText.textContent = `${item.name} - ${item.quantity} adet x ${item.priceAtSale.toFixed(2)} TL = ${(item.quantity * item.priceAtSale).toFixed(2)} TL`;
            
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Kaldır';
            removeButton.classList.add('delete');
            removeButton.onclick = () => {
                currentCart.splice(index, 1);
                renderCart();
            };
            li.appendChild(itemText);
            li.appendChild(removeButton);
            cartItemsUl.appendChild(li);
            total += item.quantity * item.priceAtSale;
        });
        cartTotalSpan.textContent = total.toFixed(2);
    }

    completeSaleButton.addEventListener('click', async () => {
        if (currentCart.length === 0) {
            alert('Sepet boş. Lütfen önce ürün ekleyin.');
            return;
        }
        const tableId = document.getElementById('tableNumber').value;
        const paymentType = document.getElementById('paymentType').value;
        const totalAmount = parseFloat(cartTotalSpan.textContent);

        const saleData = {
            items: currentCart.map(item => ({ // Sadece gerekli bilgileri gönder
                productId: item.productId,
                name: item.name, // Fişte göstermek için faydalı olabilir
                quantity: item.quantity,
                priceAtSale: item.priceAtSale
            })),
            total: totalAmount,
            tableId: parseInt(tableId),
            paymentType: paymentType
        };

        try {
            const result = await fetchData('/sales', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saleData)
            });
            alert('Satış başarıyla tamamlandı ve loglandı!');
            console.log('Fiş Verisi:', result.receiptData);
            currentCart = [];
            renderCart();
            posQuantityInput.value = 1;
            posProductSelect.value = ""; // Seçimi sıfırla
            // İsteğe bağlı: loadProducts(); // Stok güncellendiyse listeyi yenile
        } catch (error) {
            // Handled by fetchData
        }
    });

    const fetchSalesLogButton = document.getElementById('fetchSalesLogButton');
    const fetchActivityLogButton = document.getElementById('fetchActivityLogButton');
    const logTitle = document.getElementById('logTitle');
    const logDataPre = document.getElementById('logData');

    async function fetchAndDisplayLogs(logType) {
        const endpoint = logType === 'sales' ? '/logs/sales' : '/logs/activity';
        logTitle.textContent = `${logType === 'sales' ? 'Satış' : 'Aktivite'} Log Kayıtları`;
        logTitle.classList.remove('hidden');
        logDataPre.classList.remove('hidden');
        logDataPre.textContent = 'Loglar yükleniyor...';
        try {
            const logs = await fetchData(endpoint);
            logDataPre.textContent = JSON.stringify(logs, null, 2);
        } catch (error) {
            logDataPre.textContent = `Loglar yüklenirken hata oluştu.`;
        }
    }

    fetchSalesLogButton.addEventListener('click', () => fetchAndDisplayLogs('sales'));
    fetchActivityLogButton.addEventListener('click', () => fetchAndDisplayLogs('activity'));

    document.addEventListener('DOMContentLoaded', () => {
        loadProgramInfo();
        loadProducts();
    });
</script>
</body>
</html>
